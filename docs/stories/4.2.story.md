# Story 4.2: 노트 내용 기반 자동 요약 생성

## Status

Done

## Story

**As a** 사용자,
**I want** 작성한 노트의 내용을 바탕으로 3-6개의 불릿 포인트로 구성된 자동 요약을 생성하는 기능,
**so that** 긴 노트의 핵심 내용을 빠르게 파악하고 효율적으로 관리할 수 있다.

## Acceptance Criteria

1. 노트 내용이 100자 이상일 때 자동 요약 생성 버튼이 표시되어야 한다
2. 요약 생성 시 3-6개의 불릿 포인트로 구성된 요약이 생성되어야 한다
3. 요약 생성 중에는 로딩 상태가 표시되어야 한다
4. 요약 생성 완료 후 노트 상세 페이지에 요약이 표시되어야 한다
5. 요약 생성 실패 시 적절한 에러 메시지가 표시되어야 한다
6. 생성된 요약은 데이터베이스에 저장되어야 한다
7. 이미 요약이 있는 노트는 기존 요약을 표시해야 한다
8. 요약 재생성 기능이 제공되어야 한다
9. 요약 생성은 10초 이내에 완료되어야 한다
10. 토큰 제한(8k)을 초과하는 노트는 적절히 처리되어야 한다

## Tasks / Subtasks

-   [x] 요약 데이터 모델 및 스키마 구현 (AC: 6)

    -   [x] summaries 테이블 스키마 정의
    -   [x] Drizzle 스키마 파일 생성
    -   [x] 마이그레이션 파일 생성
    -   [x] 타입 정의 추가

-   [x] Gemini API 요약 생성 서비스 구현 (AC: 2, 9, 10)

    -   [x] 요약 생성 프롬프트 설계
    -   [x] 토큰 제한 검증 로직
    -   [x] Gemini API 호출 함수
    -   [x] 응답 파싱 및 검증

-   [x] 요약 생성 Server Action 구현 (AC: 5, 6, 8)

    -   [x] generateSummary Server Action
    -   [x] 에러 핸들링 로직
    -   [x] 데이터베이스 저장 로직
    -   [x] 사용자 권한 검증

-   [x] 노트 상세 페이지 UI 업데이트 (AC: 1, 3, 4, 7)

    -   [x] 요약 표시 컴포넌트
    -   [x] 요약 생성 버튼
    -   [x] 로딩 상태 표시
    -   [x] 요약 재생성 버튼

-   [x] 요약 관련 쿼리 함수 구현 (AC: 7)
    -   [x] 노트별 요약 조회 함수
    -   [x] 요약 존재 여부 확인 함수
    -   [x] 요약 업데이트 함수

## Dev Notes

### 이전 스토리 인사이트

[Source: docs/stories/4.1.story.md]

-   Gemini API 클라이언트가 구현되어 있음 (`lib/ai/gemini-client.ts`)
-   에러 처리 및 타임아웃 로직이 준비되어 있음
-   토큰 사용량 계산 유틸리티가 구현되어 있음
-   환경변수 설정이 완료되어 있음

### 데이터 모델

[Source: docs/architecture.md#2-데이터-모델]

-   **summaries 테이블 구조:**
    -   note_id (UUID, FK to notes.id)
    -   model (TEXT, AI 모델명)
    -   content (TEXT, 요약 내용)
    -   created_at (TIMESTAMP)

[Source: lib/db/schema/notes.ts]

-   기존 notes 테이블과 연관관계 설정 필요
-   Drizzle ORM 스키마 패턴 따라야 함

### API 사양

[Source: docs/architecture.md#4-서버-액션]

-   `regenerateAI` Server Action 패턴 참고
-   사용자 인증 및 권한 검증 필수
-   revalidatePath로 캐시 무효화

### 컴포넌트 사양

[Source: lib/notes/actions.ts]

-   기존 노트 액션 패턴 따라야 함
-   에러 처리 및 성공/실패 반환 구조
-   사용자 ID 스코프 검증 필수

### 파일 위치

[Source: 프로젝트 구조]

-   스키마: `lib/db/schema/summaries.ts`
-   액션: `lib/ai/actions.ts`
-   컴포넌트: `components/notes/summary-section.tsx`
-   타입: `lib/ai/types.ts` (4.1에서 생성됨)

### 테스트 요구사항

[Source: docs/architecture.md#6-배포운영]

-   Jest 테스트 프레임워크 사용
-   단위 테스트: API 호출, 데이터 변환
-   통합 테스트: Server Action, 데이터베이스 연동

### 기술 제약사항

[Source: docs/architecture.md#6-배포운영]

-   토큰 제한: 8k 토큰 (입력 + 출력)
-   타임아웃: 10초
-   Gemini 무료 할당량 고려

### Testing

#### 테스트 파일 위치

-   `__tests__/ai/summary-generation.test.ts`
-   `__tests__/components/summary-section.test.ts`

#### 테스트 표준

-   Jest + @testing-library/react 사용
-   Server Action 모킹 필요
-   API 응답 모킹 필요

#### 테스트 프레임워크

-   Jest 설정은 4.1 스토리에서 구성됨
-   React Testing Library 패턴 사용

#### 특정 테스트 요구사항

-   토큰 제한 초과 시나리오 테스트
-   API 에러 처리 테스트
-   로딩 상태 UI 테스트
-   요약 재생성 기능 테스트

## Change Log

| Date       | Version | Description | Author           |
| ---------- | ------- | ----------- | ---------------- |
| 2025-10-14 | 1.0     | 스토리 생성 | Scrum Master Bob |

## Dev Agent Record

이 섹션은 개발 에이전트가 구현 중에 채워집니다.

### Agent Model Used

Claude 3.5 Sonnet

### Debug Log References

-   토큰 제한 검증 로직 개선: `lib/ai/utils.ts`의 `validateTokenLimit` 함수
-   API 응답 JSON 파싱 오류 수정: `app/api/notes/[id]/summary/route.ts`에 try/catch 추가
-   100자 이상 노트만 요약 생성: `components/notes/summary-section.tsx`에 조건부 렌더링 추가

### Completion Notes List

-   ✅ 요약 데이터 모델 및 스키마 구현 완료
-   ✅ Gemini API 요약 생성 서비스 구현 완료
-   ✅ API 라우트 및 에러 처리 구현 완료
-   ✅ UI 컴포넌트 및 사용자 경험 개선 완료
-   ✅ 데이터베이스 쿼리 함수 구현 완료
-   ✅ 단위 테스트 작성 완료
-   ✅ 100자 이상 노트만 요약 생성하도록 조건부 렌더링 구현
-   ✅ 토큰 제한 초과 시 자동 텍스트 잘라내기 기능 구현
-   ✅ 요약 재생성 및 로딩 상태 표시 기능 구현

### File List

-   `lib/db/schema/summaries.ts` - 요약 데이터 스키마 정의
-   `lib/notes/queries.ts` - 요약 관련 쿼리 함수 (getSummaryByNoteId)
-   `app/api/notes/[id]/summary/route.ts` - 요약 생성/조회 API 라우트
-   `components/notes/summary-section.tsx` - 요약 UI 컴포넌트
-   `components/notes/note-editor.tsx` - 요약 섹션 통합
-   `__tests__/ai/summary-generation.test.ts` - AI 요약 생성 단위 테스트
-   `__tests__/components/summary-section.test.tsx` - 요약 컴포넌트 테스트

## QA Results

QA 에이전트가 완료된 스토리 구현을 검토한 결과입니다.
