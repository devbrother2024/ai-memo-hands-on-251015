# Story 4.3: 노트 내용 기반 자동 태그 생성

## Status

Ready for Review

## Story

**As a** 사용자,
**I want** 작성한 노트의 내용을 바탕으로 최대 6개의 관련성 높은 태그를 자동으로 생성하는 기능,
**so that** 노트를 효율적으로 분류하고 검색할 수 있다.

## Acceptance Criteria

1. 노트 내용이 100자 이상일 때 자동 태그 생성 버튼이 표시되어야 한다
2. 태그 생성 시 최대 6개의 관련성 높은 태그가 생성되어야 한다
3. 태그 생성 중에는 로딩 상태가 표시되어야 한다
4. 태그 생성 완료 후 노트 상세 페이지에 태그가 표시되어야 한다
5. 태그 생성 실패 시 적절한 에러 메시지가 표시되어야 한다
6. 생성된 태그는 데이터베이스에 저장되어야 한다
7. 이미 태그가 있는 노트는 기존 태그를 표시해야 한다
8. 태그 재생성 기능이 제공되어야 한다
9. 태그 생성은 10초 이내에 완료되어야 한다
10. 토큰 제한(8k)을 초과하는 노트는 적절히 처리되어야 한다
11. 생성된 태그는 클릭 가능한 형태로 표시되어야 한다
12. 태그 클릭 시 해당 태그로 필터링된 노트 목록이 표시되어야 한다

## Tasks / Subtasks

-   [x] 태그 데이터 모델 및 스키마 구현 (AC: 6)

    -   [x] tags 테이블 스키마 정의
    -   [x] note_tags 연결 테이블 스키마 정의
    -   [x] Drizzle 스키마 파일 생성
    -   [x] 마이그레이션 파일 생성
    -   [x] 타입 정의 추가

-   [x] Gemini API 태그 생성 서비스 구현 (AC: 2, 9, 10)

    -   [x] 태그 생성 프롬프트 설계
    -   [x] 토큰 제한 검증 로직
    -   [x] Gemini API 호출 함수
    -   [x] 응답 파싱 및 검증

-   [x] 태그 생성 Server Action 구현 (AC: 5, 6, 8)

    -   [x] generateTags Server Action
    -   [x] 에러 핸들링 로직
    -   [x] 데이터베이스 저장 로직
    -   [x] 사용자 권한 검증

-   [x] 노트 상세 페이지 UI 업데이트 (AC: 1, 3, 4, 7, 11)

    -   [x] 태그 표시 컴포넌트
    -   [x] 태그 생성 버튼
    -   [x] 로딩 상태 표시
    -   [x] 태그 재생성 버튼
    -   [x] 클릭 가능한 태그 UI

-   [x] 태그 관련 쿼리 함수 구현 (AC: 7, 12)

    -   [x] 노트별 태그 조회 함수
    -   [x] 태그 존재 여부 확인 함수
    -   [x] 태그 업데이트 함수
    -   [x] 태그별 노트 필터링 함수

-   [x] 태그 필터링 기능 구현 (AC: 12)

    -   [x] 태그 클릭 이벤트 처리
    -   [x] 노트 목록 필터링 로직
    -   [x] 필터 상태 관리

## Dev Notes

### 이전 스토리 인사이트

[Source: docs/stories/4.2.story.md]

-   Gemini API 클라이언트가 구현되어 있음 (`lib/ai/gemini-client.ts`)
-   요약 생성과 유사한 패턴으로 태그 생성 구현 가능
-   에러 처리 및 타임아웃 로직이 준비되어 있음
-   토큰 사용량 계산 유틸리티가 구현되어 있음
-   환경변수 설정이 완료되어 있음

### 데이터 모델

[Source: docs/architecture.md#2-데이터-모델]

-   **tags 테이블 구조:**

    -   id (UUID, PK)
    -   name (TEXT, 태그명)
    -   color (TEXT, 태그 색상)
    -   created_at (TIMESTAMP)
    -   user_id (UUID, FK to auth.users)

-   **note_tags 테이블 구조:**
    -   note_id (UUID, FK to notes.id)
    -   tag_id (UUID, FK to tags.id)
    -   created_at (TIMESTAMP)
    -   PRIMARY KEY (note_id, tag_id)

[Source: lib/db/schema/notes.ts]

-   기존 notes 테이블과 연관관계 설정 필요
-   Drizzle ORM 스키마 패턴 따라야 함

### API 사양

[Source: docs/architecture.md#4-서버-액션]

-   `generateSummary` Server Action 패턴 참고
-   사용자 인증 및 권한 검증 필수
-   revalidatePath로 캐시 무효화

### 컴포넌트 사양

[Source: lib/notes/actions.ts]

-   기존 노트 액션 패턴 따라야 함
-   에러 처리 및 성공/실패 반환 구조
-   사용자 ID 스코프 검증 필수

### 파일 위치

[Source: 프로젝트 구조]

-   스키마: `lib/db/schema/tags.ts`, `lib/db/schema/note-tags.ts`
-   액션: `lib/ai/actions.ts`
-   컴포넌트: `components/notes/tags-section.tsx`
-   타입: `lib/ai/types.ts` (4.1에서 생성됨)

### 테스트 요구사항

[Source: docs/architecture.md#6-배포운영]

-   Jest 테스트 프레임워크 사용
-   단위 테스트: API 호출, 데이터 변환
-   통합 테스트: Server Action, 데이터베이스 연동

### 기술 제약사항

[Source: docs/architecture.md#6-배포운영]

-   토큰 제한: 8k 토큰 (입력 + 출력)
-   타임아웃: 10초
-   Gemini 무료 할당량 고려
-   최대 6개 태그 생성 제한

### Testing

#### 테스트 파일 위치

-   `__tests__/ai/tag-generation.test.ts`
-   `__tests__/components/tags-section.test.ts`

#### 테스트 표준

-   Jest + @testing-library/react 사용
-   Server Action 모킹 필요
-   API 응답 모킹 필요

#### 테스트 프레임워크

-   Jest 설정은 4.1 스토리에서 구성됨
-   React Testing Library 패턴 사용

#### 특정 테스트 요구사항

-   토큰 제한 초과 시나리오 테스트
-   API 에러 처리 테스트
-   로딩 상태 UI 테스트
-   태그 재생성 기능 테스트
-   태그 필터링 기능 테스트

## Change Log

| Date       | Version | Description | Author              |
| ---------- | ------- | ----------- | ------------------- |
| 2025-01-27 | 1.0     | 스토리 생성 | Product Owner Sarah |

## Dev Agent Record

이 섹션은 개발 에이전트가 구현 중에 채워집니다.

### Agent Model Used

Claude 3.5 Sonnet

### Debug Log References

-   getServerUser 함수 누락으로 인한 빌드 에러 수정: `lib/auth/actions.ts`에 getServerUser 함수 추가
-   데이터베이스 마이그레이션 완료: tags 및 note_tags 테이블 생성
-   Gemini API 정상 작동 확인: 테스트 AI 페이지에서 헬스체크 및 텍스트 생성 성공

### Completion Notes List

-   ✅ 태그 데이터 모델 및 스키마 구현 완료
-   ✅ Gemini API 태그 생성 서비스 구현 완료
-   ✅ 태그 생성 Server Action 구현 완료
-   ✅ 태그 표시 컴포넌트 구현 완료
-   ✅ 노트 에디터에 태그 섹션 통합 완료
-   ✅ 태그 관련 쿼리 함수 구현 완료
-   ✅ 태그 필터링 기능 구현 완료
-   ✅ 단위 테스트 작성 완료
-   ✅ 데이터베이스 마이그레이션 적용 완료

### File List

-   `lib/db/schema/tags.ts` - 태그 데이터 스키마 정의
-   `lib/db/schema/note-tags.ts` - 노트-태그 연결 스키마 정의
-   `lib/ai/types.ts` - 태그 생성 관련 타입 정의 추가
-   `lib/ai/tag-generation.ts` - 태그 생성 서비스 구현
-   `lib/notes/tag-queries.ts` - 태그 관련 쿼리 함수 구현
-   `lib/ai/actions.ts` - 태그 생성 Server Action 구현
-   `lib/auth/actions.ts` - getServerUser 함수 추가
-   `components/notes/tags-section.tsx` - 태그 표시 컴포넌트
-   `components/notes/note-editor.tsx` - 태그 섹션 통합
-   `app/notes/page.tsx` - 태그 필터링 기능 추가
-   `__tests__/ai/tag-generation.test.ts` - 태그 생성 서비스 테스트
-   `__tests__/components/tags-section.test.tsx` - 태그 컴포넌트 테스트

## QA Results

QA 에이전트가 완료된 스토리 구현을 검토한 결과입니다.
